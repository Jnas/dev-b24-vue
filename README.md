# Инструкция по разработке приложений для Битрикс24

## 1. Введение

Эта инструкция описывает структуру и процесс разработки приложений для Битрикс24 с использованием Vue.js


## 2. Структура проекта

### Общая структура

```
src/
├── mock/                # Моковые данные для разработки
├── features/            # Фичи (функциональные модули приложения)
├── shared/              # Общие компоненты и утилиты
└── AppMount.vue         # Основной точка входа (не подлежит переименованию)
```

### Подробное описание папок

#### mock/
- Назначение: содержит моковые данные для работы в режиме разработки
- Особенности: папка всегда должна находиться в текущем расположении проекта
- Содержание: JSON-файлы с эмуляцией данных от Битрикс24 (placement info, API-ответы)

#### features/
Содержит функциональные модули приложения, каждый из которых представляет отдельную фичу:

```
features/
└── [feature-name]/
    ├── components/       # UI-компоненты для данной фичи
    ├── managers/         # Логика в виде композаблов (useAuth, useLogin)
    ├── services/         # API-сервисы и бизнес-логика
    └── [FeatureName].vue # Основной компонент фичи
```

Пример структуры:
```
features/
├── auth/
│   ├── components/
│   │   └── LoginForm.vue
│   ├── managers/
│   │   └── useAuth.js
│   ├── services/
│   │   └── authService.js
│   └── AuthComponent.vue
└── profile/
    └── ...
```

#### shared/
Содержит переиспользуемые элементы по всему приложению:

```
shared/
├── components/          # Переиспользуемые UI-компоненты
├── composables/         # Общие композаблы
├── utils/               # Вспомогательные функции
└── types/               # TypeScript типы
```

## 3. API приложения

Объект `api()` предоставляет доступ к функциональности Битрикс24 и вспомогательным инструментам.

### 3.1. Свойства api()

#### api().fields
Содержит свойства, передаваемые приложению из Битрикс24.

- **api().fields.placement** - данные, передаваемые из Битрикс24, аналогичные функции `BX24.placement.info`
    - Документация: [BX24.placement.info](https://apidocs.bitrix24.ru/api-reference/widgets/ui-interaction/bx24-placement-info.html)

### 3.2. Методы api()

#### api().methods.b24Call
Асинхронный метод для выполнения запросов к REST API Битрикс24.

- Аналогичен методу `BX24.callMethod`, но возвращает Promise
- Использование: `const response = await api().methods.b24Call('method.name', params)`
- Не требует callback-параметра, что упрощает работу с асинхронным кодом
- Документация: [BX24.callMethod](https://apidocs.bitrix24.ru/api-reference/bx24-js-sdk/how-to-call-rest-methods/bx24-call-method.html)

#### api().methods.axios
Стандартный плагин Axios (версия 1.11.0) для выполнения HTTP-запросов.

- Назначение: выполнение запросов к внешним API или кастомным бэкенд-сервисам
- Документация: [Axios](https://axios-http.com/docs/intro)

#### api().methods.toast
Интеграция с библиотекой "vue-toastification" (версия ^2.0.0-rc.5).

- Назначение: отображение уведомлений и информационных сообщений пользователю
- Пример использования: `api().methods.toast.success('Операция выполнена!')`

#### api().methods.openCustomScript
Метод для открытия пользовательских скриптов в слайдере.

- Синтаксис: `api().methods.openCustomScript(scriptName: string, params = {})`
- Важно: метод недоступен в режиме разработки, работает только после компиляции и загрузки в Битрикс24
- Назначение: переход между различными скриптами внутри приложения

## 4. Работа с mock-данными

Поскольку режим разработки изолирован от Битрикс24, необходимо создать моковые данные для тестирования.

### 4.1. Получение данных placement

1. В приложении Битрикс24 создайте встройку и включите режим разработки
2. Перейдите к месту размещения виджета в интерфейсе Битрикс24
3. Нажмите кнопку "Разработка" в месте размещения виджета
4. В открывшемся слайдере нажмите "Входные данные" (в правом верхнем углу)
5. Нажмите иконку экспорта (↑) для сохранения файла
6. Поместите сохраненный файл в папку `mock/`

Теперь при вызове `api().fields.placement` в режиме разработки будут использоваться сохраненные данные.

### 4.2. Создание mock-запросов к API

1. В режиме веб-разработки нажмите "Отладчик API" (правый верхний угол)
2. В поле "Метод" укажите название API-метода (например, `user.get`)
3. В поле "Данные JSON" укажите параметры запроса:
   ```json
   {
     "filter": {
       "ID": 1
     }
   }
   ```
4. Нажмите "Отправить"
5. После получения ответа нажмите иконку экспорта (↑)
6. Сохраните файл в папку `mock/`

Пример структуры mock-файла:
```json
{
  "method": "user.get",
  "params": {
    "filter": {
      "ID": 1
    }
  },
  "response": {
    "result": [...],
    "total": 1
  },
  "delay": 200
}
```

Примечание: Параметр `delay` можно редактировать вручную для эмуляции различных скоростей ответа API.

## 5. Установка и запуск

### 5.1. Установка зависимостей

Перед первым запуском проекта выполните в корне проекта:

```bash
npm install
```

### 5.2. Режим разработки

Для запуска режима разработки используйте команду:

```bash
npm run dev
```

После запуска в консоли будет указан адрес, по которому доступно приложение (обычно `http://localhost:5173`).

### 5.3. Сборка проекта

Для компиляции приложения в production-версию выполните:

```bash
npm run build
```

После выполнения команды в папке `dist/` появятся файлы:
- `dev-b24vue.js` - основной JavaScript-файл
- `dev-b24vue.css` - стили приложения (если использовались)

### 5.4. Деплой в Битрикс24

1. Перейдите в режим веб-разработки в Битрикс24
2. Переключитесь на режим "Загрузка готового решения"
3. Загрузите скомпилированные файлы из папки `dist/`
4. Сохраните изменения

После загрузки файлы будут автоматически применяться при открытии виджета.

## 6. Примеры использования

### Пример 1: Получение данных о пользователе

```javascript
// В composables/user.js
export const useUser = () => {
  const getUser = async (userId) => {
    try {
      const response = await api().methods.b24Call('user.get', {
        filter: { ID: userId }
      });
      return response.result[0];
    } catch (error) {
      api().methods.toast.error('Ошибка загрузки данных пользователя');
      throw error;
    }
  };
  
  return { getUser };
};
```

### Пример 2: Отображение уведомления

```javascript
// В компоненте
import { useUser } from '@/features/user/composables/useUser';

export default {
  setup() {
    const { getUser } = useUser();
    
    const loadUser = async () => {
      try {
        const user = await getUser(1);
        api().methods.toast.success(`Пользователь ${user.NAME} загружен`);
      } catch (error) {
        // Обработка ошибки
      }
    };
    
    return { loadUser };
  }
};
```

## 7. Дополнительные ресурсы

- [Официальная документация REST API Битрикс24](https://apidocs.bitrix24.ru/api-reference/)
- [Справочник методов user.get](https://apidocs.bitrix24.ru/api-reference/user/user-get.html)
- [Документация по виджетам и взаимодействию с UI](https://apidocs.bitrix24.ru/api-reference/widgets/)
- [Документация BX24 JS SDK](https://apidocs.bitrix24.ru/api-reference/bx24-js-sdk/)